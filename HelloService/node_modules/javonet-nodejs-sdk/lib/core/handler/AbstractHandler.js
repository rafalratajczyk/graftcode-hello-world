// @ts-check
import { Command } from '../../utils/Command.js'

class AbstractHandler {
    /**
     * @type {Record<number, AbstractHandler>}
     */
    handlers = []

    constructor() {
        if (new.target === AbstractHandler) throw new TypeError('You cannot instantiate abstract class')
    }

    /**
     * @param {Command} command
     */
    process(command) {
        throw new Error('process must be implemented')
    }

    /**
     * @param {Command} command
     */
    handleCommand(command) {
        this.iterate(command)
        return this.process(command)
    }

    /**
     * @param {Command} command
     */
    iterate(command) {
        for (let i = 0; i < command.payload.length; i++) {
            if (command.payload[i] instanceof Command) {
                let inner = command.payload[i]
                command.payload[i] = this.handlers[inner.commandType].handleCommand(inner)
            }
        }
    }

    /**
     *
     * @param {*} error
     * @param {*} class_name
     * @returns
     */
    process_stack_trace(error, class_name) {
        let stackTraceArray = error.stack.split('\n').map((/** @type {string} */ frame) => frame.trim())
        stackTraceArray.forEach((/** @type {string} */ str, /** @type {number} */ index) => {
            if (str.includes(class_name)) {
                stackTraceArray = stackTraceArray
                    .slice(0, index)
                    .filter((/** @type {string} */ s) => !s.includes(class_name))
            }
        })
        error.stack = stackTraceArray.join(' \n ')
        return error
    }
}

export { AbstractHandler }
