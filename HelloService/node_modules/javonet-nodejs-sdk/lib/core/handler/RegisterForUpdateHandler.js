// @ts-check
import { AbstractHandler } from './AbstractHandler.js'

export class RegisterForUpdateHandler extends AbstractHandler {
    requiredParametersCount = 2
    /* type {Map<string, any>} */
    static _invocationContexts = { Value: new Map() }

    /**
     * Ensure context map exists and return it.
     * @returns {Map<string, any>}
     */
    static getOrCreateContextMap() {
        const container = RegisterForUpdateHandler._invocationContexts
        if (!container.Value) {
            container.Value = new Map()
        }
        return container.Value
    }

    /**
     * @param {any} command
     * @returns {any}
     */
    process(command) {
        if (command.payload.length < this.requiredParametersCount) {
            throw new Error('RegisterForUpdateHandler parameters mismatch')
        }

        const objectToRegister = command.payload[0]
        const guidToRegister = command.payload.length > 1 && typeof command.payload[1] === 'string' ? command.payload[1] : '' // Guid.Empty -> empty string

        const contextMap = RegisterForUpdateHandler.getOrCreateContextMap()
        if (!contextMap.has(guidToRegister)) {
            contextMap.set(guidToRegister, objectToRegister)
        }

        return objectToRegister
    }
}
